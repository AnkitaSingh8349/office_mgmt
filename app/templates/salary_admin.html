{% extends "go_admin.html" %}

{% block content %}

<!-- ONLY LOAD BOOTSTRAP HERE (NOT IN go_admin.html) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

<section class="container py-4">

  <!-- HEADER -->
  <header class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="mb-0">ðŸ’° Salary / Reports</h3>
    <small class="text-muted">Manage salary slips, attendance & monthly reports</small>
  </header>

  <!-- ATTENDANCE & ABSENT CARDS -->
  <div class="row g-3 mb-4">
    <div class="col-12 col-md-6">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <h5 class="card-title mb-1">Attendance</h5>
            <small class="text-muted">Total present (all employees)</small>
          </div>
          <div class="text-primary fw-bold display-6">{{ total_attendance }}</div>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-6">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <h5 class="card-title mb-1">Absent</h5>
            <small class="text-muted">Leaves recorded this month</small>
          </div>
          <div class="text-danger fw-bold display-6">{{ total_absent }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- SALARY TABLE -->
  <div class="card mb-4 shadow-sm">
    <div class="card-body">
      <div class="table-responsive">

        <table class="table table-striped table-hover align-middle">
          <thead class="table-dark">
            <tr class="text-center">
              <th>ID</th>
              <th>Employee</th>
              <th>Month</th>
              <th>Attend</th>
              <th>Absent</th>
              <th>Base</th>
              <th>Deductions</th>
              <th>Net</th>
              <th>Slip</th>
              <th>Upload</th>
            </tr>
          </thead>

          <tbody>
            {% for row in rows %}
              {% set s = row.salary %}
              {% set emp = row.employee %}
              <tr class="text-center">

               <td>{{ emp.id if emp else s.employee_id }}</td>


                <td>{{ emp.name if emp else ('#' ~ s.employee_id) }}</td>

                <td>{{ s.month or '-' }}</td>

                <td>{{ row.attendance_count }}</td>

                <!-- CLICKABLE ABSENT DETAILS -->
                <td>
                  <button class="btn btn-sm btn-outline-danger" 
                          onclick="showAbsentDetails('{{ emp.name }}', '{{ s.employee_id }}', '{{ s.month }}')">
                    {{ row.absent_count }}
                  </button>
                </td>

                <td>â‚¹ {{ "%.2f"|format(s.base_salary or 0) }}</td>
                <td>â‚¹ {{ "%.2f"|format(s.deductions or 0) }}</td>
                <td class="fw-bold text-success">â‚¹ {{ "%.2f"|format(s.net_salary or 0) }}</td>

                <!-- âœ… ONLY CHANGE: FIX DOWNLOAD URL -->
                <td>
                  {% if s.slip_file %}
                   <a href="{{ url_for('download_salary', salary_id=s.id) }}"
   class="btn btn-sm btn-outline-primary">
                      Download
                  {% else %}
                    <span class="text-muted">No slip</span>
                  {% endif %}
                </td>

                <td>
                  <form action="/salary/admin/upload/{{ s.id }}" method="post" enctype="multipart/form-data"
                        class="d-flex justify-content-center">
                    <input type="file" name="file" accept="application/pdf"
                           class="form-control form-control-sm"
                           style="max-width:160px;" required>
                    <button class="btn btn-sm btn-success ms-2" type="submit">Upload</button>
                  </form>
                </td>

              </tr>
            {% endfor %}
          </tbody>

        </table>

      </div>
    </div>
  </div>

  <!-- ACTION BUTTONS -->
  <div class="d-flex flex-column flex-sm-row gap-2">
    <a href="/salary/run?generate_pdf=true" class="btn btn-primary w-100 w-sm-auto">
      Run salary engine (PDF)
    </a>

    <button id="summary-api-btn" class="btn btn-outline-secondary w-100 w-sm-auto">
      Summary API
    </button>
  </div>

</section>

<!-- ABSENT DETAIL MODAL -->
<div class="modal fade" id="absentModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Absent Details</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <p><strong>Employee:</strong> <span id="abs-name"></span></p>
        <p><strong>Month:</strong> <span id="abs-month"></span></p>

        <div id="abs-loading">Loadingâ€¦</div>

        <ul id="abs-list" class="list-group"></ul>
      </div>

    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
  {{ super() }}

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    function showAbsentDetails(name, empId, month) {
      document.getElementById("abs-name").innerText = name;
      document.getElementById("abs-month").innerText = month;
      document.getElementById("abs-loading").style.display = "block";
      document.getElementById("abs-list").innerHTML = "";

      fetch(`/api/get_absent_days/${empId}/${month}`)
        .then(r => r.json())
        .then(data => {
          document.getElementById("abs-loading").style.display = "none";
          if (!data.days || data.days.length === 0) {
            document.getElementById("abs-list").innerHTML =
              `<li class="list-group-item text-muted">No absent days recorded</li>`;
          } else {
            data.days.forEach(d => {
              document.getElementById("abs-list").innerHTML +=
                `<li class="list-group-item">${d}</li>`;
            });
          }
        });

      new bootstrap.Modal(document.getElementById("absentModal")).show();
    }
  </script>

{% endblock %}
