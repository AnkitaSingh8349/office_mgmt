<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Admin Dashboard</title>

    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #f2f4f8;
        }

        /* Header */
        header {
            background: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #ddd;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        header h2 {
            margin: 0;
            color: #333;
            font-size: 24px;
            font-weight: 700;
        }
        header p {
            margin: 3px 0 0;
            color: #666;
            font-size: 14px;
        }
        .logout-btn {
            padding: 9px 16px;
            background: linear-gradient(90deg, #ff4d4d, #ff1a1a);
            color: white;
            border-radius: 6px;
            text-decoration: none;
            font-weight: bold;
            transition: 0.3s;
            border: none;
            cursor: pointer;
        }
        .logout-btn:hover {
            filter: brightness(1.1);
        }

        /* Dashboard Layout */
        .container {
            padding: 30px;
            max-width: 1250px;
            margin: auto;
        }

        .section-title {
            font-size: 22px;
            margin-bottom: 12px;
            color: #222;
        }

        /* Links Section */
        .link-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
            gap: 20px;
            margin-bottom: 35px;
        }

        .link-card {
            background: white;
            padding: 24px 20px;
            border-radius: 12px;
            border: 1px solid #dcdcdc;
            text-align: center;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        /* Green hover/click effect */
        .link-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 14px rgba(0,0,0,0.1);
            border-color: #4CAF50;
            background: #e9f9ee;
        }

        .link-card:active {
            background: #c9f5d3;
            transform: scale(0.98);
        }

        .link-card a {
            text-decoration: none;
            color: #333;
            font-weight: 600;
        }

        /* Summary Cards */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
            gap: 18px;
        }
        .summary-card {
            background: white;
            padding: 22px;
            border-radius: 12px;
            border: 1px solid #e3e3e3;
            text-align: center;
            transition: 0.2s;
        }
        .summary-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }
        .summary-card strong {
            font-size: 18px;
            display: block;
            margin-bottom: 6px;
            color: #444;
        }
        .summary-card div {
            font-size: 15px;
            color: #777;
        }

        /* Modal (simple, no bootstrap) */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.45);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal {
            width: 92%;
            max-width: 900px;
            background: white;
            border-radius: 10px;
            padding: 18px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
            max-height: 85vh;
            overflow: auto;
        }
        .modal .modal-header {
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-bottom: 12px;
        }
        .modal .close-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }
        .list-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }
        .list-box {
            background:#fbfcfd;
            border:1px solid #eef2f5;
            padding:10px;
            border-radius:8px;
            min-height:60px;
        }
        .present-item, .absent-item {
            display:flex;
            justify-content:space-between;
            padding:8px;
            border-bottom:1px solid #eee;
            font-size:14px;
        }
        .present-item:last-child, .absent-item:last-child { border-bottom: none; }

        .meta-row {
            display:flex;
            gap:12px;
            align-items:center;
            margin-bottom:10px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            header h2 { font-size: 20px; }
            .section-title { font-size: 20px; }
            .link-card { font-size: 17px; }
            .list-grid { grid-template-columns: 1fr; }
            .modal { width: 96%; padding:14px; }
        }
    </style>

</head>

<body>

<header>
    <div>
        <h2>Welcome {{ current_user.name if current_user and current_user.name else 'Admin' }} üëë</h2>
        <p>You are logged in as {{ (current_user.role|capitalize) if current_user and current_user.role else 'Admin' }}.</p>
    </div>
   <div>
    <form action="/auth/logout" method="post" style="display:inline;">
        <button type="submit" class="logout-btn">Logout</button>
    </form>
</div>

</header>

{# --- MAIN CONTENT BLOCK: child templates render here --- #}
{% block content %}
<div class="container">

    <!-- Dashboard Links (default content; child templates usually override this block) -->
    <h3 class="section-title">Admin Dashboard</h3>
    <p style="margin-bottom: 15px; color:#555;">Quick links to manage the system:</p>

    <div class="link-grid">
        <div class="link-card"><a href="/employees">üë• Manage Employees</a></div>
        <div class="link-card"><a href="/leaves/ui/pending">üìù Approve Leaves</a></div>
        <div class="link-card"><a href="/salary/admin">üí∞ Salary / Reports</a></div>
        <div class="link-card"><a href="/tasks">üìå Task Management</a></div>

        <!-- NEW: Button to show who's checked-in (present) -->
        <div class="link-card" id="openPresenceCard" style="background:#eef8ff;border-color:#cfeeff;">
            üë• <span style="margin-left:8px">Who's Checked In</span>
        </div>
    </div>

    <!-- Summary Cards -->
    <h4 class="section-title">Summary</h4>

    <div class="summary-grid">
        <div class="summary-card">
            <strong>Employees</strong>
            <div id="summaryEmployees">‚Äî</div>
        </div>
        <div class="summary-card">
            <strong>Pending Leaves</strong>
            <div id="summaryLeaves">‚Äî</div>
        </div>
        <div class="summary-card">
            <strong>Pending Tasks</strong>
            <div id="summaryTasks">‚Äî</div>
        </div>
    </div>

</div>
{% endblock %}
{# --- end main content block --- #}


<!-- Modal: All Presence (kept in parent so it's available on every admin page) -->
<div class="modal-backdrop" id="presenceBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="presenceTitle">
    <div class="modal-header">
      <div>
        <strong id="presenceTitle">Today's Attendance</strong>
        <div style="font-size:13px;color:#666;" id="presenceDate">‚Äî</div>
      </div>
      <div>
        <button class="close-btn" id="closePresence">&times;</button>
      </div>
    </div>

    <div class="meta-row">
        <div style="font-size:14px;color:#555;">Present: <strong id="modalPresentCount">0</strong></div>
        <div style="font-size:14px;color:#555;">Absent: <strong id="modalAbsentCount">0</strong></div>
        <div style="font-size:14px;color:#555;">Total Employees: <strong id="modalTotalCount">0</strong></div>
        <div style="margin-left:auto;"><button id="refreshPresence" style="padding:6px 10px;border-radius:6px;border:1px solid #ddd;background:#f8f9fb;cursor:pointer;">Refresh</button></div>
    </div>

    <div class="list-grid" style="margin-bottom:10px;">
        <div class="list-box">
            <div style="font-weight:600;margin-bottom:8px;">Present (Checked In)</div>
            <div id="presentList"></div>
        </div>
        <div class="list-box">
            <div style="font-weight:600;margin-bottom:8px;">Absent (Not Checked In)</div>
            <div id="absentList"></div>
        </div>
    </div>

    <div style="font-weight:600;margin-bottom:8px;">Recent Attendance Rows</div>
    <div style="max-height:36vh; overflow:auto; border:1px solid #eee; border-radius:6px; background:#fff;">
        <table style="width:100%; border-collapse:collapse; font-size:13px;">
            <thead style="background:#fafafa; position:sticky; top:0; z-index:1;">
                <tr>
                    <th style="padding:8px;border-bottom:1px solid #eee;text-align:left">Date</th>
                    <th style="padding:8px;border-bottom:1px solid #eee;text-align:left">Employee</th>
                    <th style="padding:8px;border-bottom:1px solid #eee;text-align:left">Check In</th>
                    <th style="padding:8px;border-bottom:1px solid #eee;text-align:left">Check Out</th>
                    <th style="padding:8px;border-bottom:1px solid #eee;text-align:left">Status</th>
                </tr>
            </thead>
            <tbody id="recentRows" style="background:#fff"></tbody>
        </table>
    </div>

    <div style="margin-top:12px; display:flex; justify-content:flex-end; gap:8px;">
        <a class="link-card" style="padding:8px 12px;background:#fff;border:1px solid #ddd;text-decoration:none;color:#333;" href="/admin/attendance">Open full Attendance page</a>
        <button id="closePresenceFooter" class="link-card" style="padding:8px 12px;background:#4CAF50;color:#fff;border:none;cursor:pointer;">Close</button>
    </div>

  </div>
</div>

<script>
/* JS unchanged ‚Äî modal logic and summary fetches */
function q(id){ return document.getElementById(id); }

function parseIsoOrDate(dateStr){
    if(!dateStr) return null;
    const d = new Date(dateStr);
    return isNaN(d) ? null : d;
}
function fmtTime(dateObj){
    if(!dateObj) return "-";
    return dateObj.toLocaleTimeString([], {hour:'numeric', minute:'2-digit'});
}
function fmtDateFriendly(isoDate){
    if(!isoDate) return "-";
    const parts = isoDate.toString().slice(0,10).split("-");
    if(parts.length!==3) return isoDate;
    const d = new Date(parts[0], parseInt(parts[1],10)-1, parts[2]);
    return d.toLocaleDateString([], { weekday:'short', month:'short', day:'numeric', year:'numeric' });
}

async function fetchJson(url, opts = {}){
    const r = await fetch(url, { credentials: "same-origin", headers: { "Accept": "application/json" }, ...opts });
    const text = await r.text();
    let json = null;
    try{ json = text ? JSON.parse(text) : null; }catch(e){}
    if(!r.ok){
        const err = json && (json.detail||json.error) ? (json.detail||json.error) : ("HTTP " + r.status);
        throw new Error(err);
    }
    return json;
}

/* Modal control */
const backdrop = q('presenceBackdrop');
const openCard = q('openPresenceCard');
const closeBtn = q('closePresence');
const closeFooter = q('closePresenceFooter');
const refreshBtn = q('refreshPresence');

if (openCard) {
  openCard.addEventListener('click', () => {
      backdrop.style.display = 'flex';
      loadPresence(); // load when opening
  });
}
if (closeBtn) closeBtn.addEventListener('click', () => backdrop.style.display = 'none');
if (closeFooter) closeFooter.addEventListener('click', () => backdrop.style.display = 'none');
window.addEventListener('keydown', (ev) => { if(ev.key === 'Escape') backdrop.style.display = 'none'; });
if (refreshBtn) refreshBtn.addEventListener('click', () => loadPresence());

async function loadPresence(){
    q('presentList').innerHTML = "";
    q('absentList').innerHTML = "";
    q('recentRows').innerHTML = "";
    q('modalPresentCount').innerText = "0";
    q('presenceDate').innerText = (new Date()).toLocaleDateString();
    q('modalPresentCount').innerText = "0";
    q('modalAbsentCount').innerText = "0";
    q('modalTotalCount').innerText = "0";

    let employees = null;
    let rows = null;
    let usedSummaryAll = false;

    try {
        employees = await fetchJson('/attendance/admin/summary-all');
        if (employees && Array.isArray(employees.employees)) {
            usedSummaryAll = true;
            employees = employees.employees;
        } else {
            employees = null;
        }
    } catch(e){ employees = null; }

    try {
        rows = await fetchJson('/attendance/admin/data');
    } catch(e){ rows = null; }

    const todayStr = new Date().toISOString().slice(0,10);

    if (usedSummaryAll && employees){
        const present = [];
        const absent = [];
        employees.forEach(emp => {
            const isPresent = !!emp.check_in;
            if(isPresent) present.push(emp);
            else absent.push(emp);
        });

        q('modalPresentCount').innerText = present.length;
        q('modalAbsentCount').innerText = absent.length;
        q('modalTotalCount').innerText = employees.length;

        if(present.length === 0){
            const p = document.createElement('div'); p.className='present-item'; p.innerText='No one checked in today';
            q('presentList').appendChild(p);
        } else {
            present.forEach(p => {
                const d = parseIsoOrDate(p.check_in);
                const div = document.createElement('div'); div.className='present-item';
                div.innerHTML = `<span>${p.name ?? ('#'+p.id)}</span><span style="color:#2b7a2b">${d ? fmtTime(d): '-'}</span>`;
                q('presentList').appendChild(div);
            });
        }

        if(absent.length === 0){
            const p = document.createElement('div'); p.className='absent-item'; p.innerText='No absentees';
            q('absentList').appendChild(p);
        } else {
            absent.forEach(a => {
                const div = document.createElement('div'); div.className='absent-item';
                div.innerHTML = `<span>${a.name ?? ('#'+a.id)}</span><span style="color:#aa3333">Absent</span>`;
                q('absentList').appendChild(div);
            });
        }

    } else {
        if (!rows || !Array.isArray(rows)) {
            const p = document.createElement('div'); p.className='present-item'; p.innerText='No attendance data available';
            q('presentList').appendChild(p);
            q('modalPresentCount').innerText = "0";
            q('modalAbsentCount').innerText = "N/A";
            q('modalTotalCount').innerText = "N/A";
        } else {
            const todays = rows.filter(r => String(r.date).slice(0,10) === todayStr);
            const presentMap = new Map();
            todays.forEach(r => {
                if (r.check_in) {
                    const key = r.employee_id ?? r.employee_name ?? JSON.stringify(r);
                    if (!presentMap.has(key)) {
                        presentMap.set(key, { id: r.employee_id, name: r.employee_name, check_in: r.check_in });
                    }
                }
            });

            if (presentMap.size === 0) {
                const p = document.createElement('div'); p.className='present-item'; p.innerText='No check-ins recorded for today';
                q('presentList').appendChild(p);
            } else {
                for (const [k, v] of presentMap.entries()) {
                    const d = parseIsoOrDate(v.check_in);
                    const div = document.createElement('div'); div.className='present-item';
                    div.innerHTML = `<span>${v.name ?? ('#'+v.id)}</span><span style="color:#2b7a2b">${d ? fmtTime(d): '-'}</span>`;
                    q('presentList').appendChild(div);
                }
            }

            q('modalPresentCount').innerText = String(presentMap.size);
            q('modalAbsentCount').innerText = "N/A";
            q('modalTotalCount').innerText = String(rows.length);
        }
    }

    try {
        const recent = rows && Array.isArray(rows) ? rows.slice(0,200) : [];
        q('recentRows').innerHTML = "";
        if (recent.length === 0){
            const tr = document.createElement('tr');
            tr.innerHTML = `<td style="padding:10px" colspan="5" class="text-muted">No recent attendance rows</td>`;
            q('recentRows').appendChild(tr);
        } else {
            recent.forEach(r => {
                const inDt = parseIsoOrDate(r.check_in);
                const outDt = parseIsoOrDate(r.check_out);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                   <td style="padding:8px;border-bottom:1px solid #f1f1f1">${fmtDateFriendly(r.date)}</td>
                   <td style="padding:8px;border-bottom:1px solid #f1f1f1">${r.employee_name ?? ('#'+r.employee_id)}</td>
                   <td style="padding:8px;border-bottom:1px solid #f1f1f1">${inDt ? fmtTime(inDt): '-'}</td>
                   <td style="padding:8px;border-bottom:1px solid #f1f1f1">${outDt ? fmtTime(outDt): '-'}</td>
                   <td style="padding:8px;border-bottom:1px solid #f1f1f1">${r.status ?? '-'}</td>
                `;
                q('recentRows').appendChild(tr);
            });
        }
    } catch(e){
        console.error('recent render error', e);
    }

    try {
        const empSummary = await fetchJson('/employees/admin/summary').catch(()=>null);
        q('summaryEmployees').innerText = empSummary && empSummary.total ? empSummary.total : 'N/A';
    } catch(e){
        q('summaryEmployees').innerText = 'N/A';
    }

    try {
        const leaves = await fetchJson('/api/leaves/admin/summary').catch(()=>null);
        q('summaryLeaves').innerText = leaves && (typeof leaves.pending !== 'undefined') ? leaves.pending : 'N/A';
    } catch(e){
        q('summaryLeaves').innerText = 'N/A';
    }

    try {
        const tasks = await fetchJson('/admin/summary').catch(()=>null);
        q('summaryTasks').innerText = tasks && (typeof tasks.pending !== 'undefined') ? tasks.pending : 'N/A';
    } catch(e){
        q('summaryTasks').innerText = 'N/A';
    }
}

/* Load once to show small counts on page (non-blocking) */
(async function loadPageSummary(){
    try {
        const l = await fetchJson('/api/leaves/admin/summary').catch(()=>null);
        q('summaryLeaves').innerText = l && (typeof l.pending !== 'undefined') ? l.pending : '‚Äî';
    } catch(e){ q('summaryLeaves').innerText = '‚Äî'; }

    try {
        const t = await fetchJson('/admin/summary').catch(()=>null);
        q('summaryTasks').innerText = t && (typeof t.pending !== 'undefined') ? t.pending : '‚Äî';
    } catch(e){ q('summaryTasks').innerText = '‚Äî'; }

    try {
        const e = await fetchJson('/employees/admin/summary').catch(()=>null);
        q('summaryEmployees').innerText = e && e.total ? e.total : '‚Äî';
    } catch(e){ q('summaryEmployees').innerText = '‚Äî'; }
})();
</script>

</body>
</html>
